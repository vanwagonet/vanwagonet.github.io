<!doctype html>
<html><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>JSON and POST in PHP - Andy’s Scribbles</title><meta name="author" content="Andy VanWagoner"/><meta name="description" content="Andy’s Scribbles"/><link rel="icon" href="/assets/images/favicon.ico"/><link rel="alternative" type="application/atom+xml" title="RSS" href="atom.xml"/><link rel="stylesheet" href="/assets/css/style.css"/><header><h1><a href="https://andy.vanwago.net">Andy’s Scribbles <img class="logo" alt="Inkwell with angle brackets" src="/assets/images/favicon.svg"/></a></h1></header><main><div><article class="post" itemscope="" itemType="http://schema.org/BlogPosting"><h2 itemProp="headline"><a href="https://andy.vanwago.net/2009/02/04/json-and-post-in-php/" itemProp="url">JSON and POST in PHP</a></h2><div class="meta"><time itemProp="datePublished" dateTime="2009-02-05T05:25:03.000Z">Feb 04, 2009</time> in <span><a class="category-link" href="/categories/distributed-system-design/">Distributed System Design</a></span></div><div itemProp="articleBody"><div><p>As I’ve been trying to do Lab 2 without having to modify my ami or change my apache configuration, I’ve found some nice helpers.</p>
<p>First, trying to encode and decode JSON in PHP 5.2 is easy… you just use the built in functions json_encode() and json_decode(). However, my Fedora ami is only running PHP 5.03. So, how do I use JSON without recompiling my php installation, or downloading 5 billion files? Michal Migurski created a php-json library that is now a part of PEAR, but he still has a copy of his original encoder/decoder at <a href="http://mike.teczno.com/JSON/JSON.phps" target="_blank" rel="noopener">http://mike.teczno.com/JSON/JSON.phps</a>. It’s licenced BSD-style so have at it.</p>
<p>Next, I wanted to sent http requests by POST, including file uploads, again without downloading 5 billion files or messing with my ami. My solution was to actually learn the ‘application/x-www-form-urlencoded’ format and ‘multipart/form-data’ format and send the HTTP request across a socket.</p>
<p>A resource that helped me with the ‘application/x-www-form-urlencoded’ format is on <a href="http://www.wellho.net/resources/ex.php4?item=h110/getpost.php" target="_blank" rel="noopener">www.wellho.net</a>. For the ‘multipart/form-data’ format <a href="http://chxo.com/be2/20050724_93bf.html" target="_blank" rel="noopener">http://chxo.com/be2/20050724_93bf.html</a> was very helpful. One gotcha to remember though is that PHP heredoc strings usually use \n line endings. While this may not cause any problems, to be safe and consistent with HTTP, you should use \r\n line endings.</p>
<p>Putting the two together into one function gave me the following:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">http_post</span><span class="params">($host, $path, $data_hash, $file = <span class="string">''</span>, $file_param_name = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	$boundary = md5(uniqid());</span><br><span class="line">	<span class="keyword">if</span> ($file &amp;&amp; $file_param_name) &#123;</span><br><span class="line">		$binary = file_get_contents($file[<span class="string">'tmp_name'</span>]);</span><br><span class="line"></span><br><span class="line">		$content_type = <span class="string">"multipart/form-data; boundary=$boundary"</span>;</span><br><span class="line"></span><br><span class="line">		$items = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span> (array_keys($data_hash) <span class="keyword">as</span> $key) &#123;</span><br><span class="line">			array_push($items, <span class="string">"--$boundary\r\nContent-Disposition: form-data; name=\"$key\"\r\n\r\n&#123;$data_hash[$key]&#125;\r\n"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		array_push($items, <span class="string">"--$boundary\r\nContent-Disposition: form-data; name=\"$file_param_name\"; filename=\"&#123;$file['name']&#125;\"\r\n"</span>);</span><br><span class="line">		array_push($items, <span class="string">"Content-Type: &#123;$file['type']&#125;\r\nContent-Transfer-Encoding: binary\r\n\r\n$binary\r\n--$boundary--\r\n"</span>);</span><br><span class="line">		$data = implode(<span class="string">''</span>, $items);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$content_type = <span class="string">'application/x-www-form-urlencoded; charset=UTF-8'</span>;</span><br><span class="line"></span><br><span class="line">		$items = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span> (array_keys($data_hash) <span class="keyword">as</span> $key) &#123;</span><br><span class="line">			array_push($items, urlencode($key) . <span class="string">'='</span> . urlencode($data_hash[$key]));</span><br><span class="line">		&#125;</span><br><span class="line">		$data = implode(<span class="string">'&amp;'</span>, $items);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$content_length = strlen($data);</span><br><span class="line">	$fp = fsockopen($host, <span class="number">80</span>);</span><br><span class="line">	fputs($fp, <span class="string">"POST $path HTTP/1.1\r\n"</span>);</span><br><span class="line">	fputs($fp, <span class="string">"Host: $host\r\n"</span>);</span><br><span class="line">	fputs($fp, <span class="string">"Content-Type: $content_type\r\n"</span>);</span><br><span class="line">	fputs($fp, <span class="string">"Content-Length: $content_length\r\n"</span>);</span><br><span class="line">	fputs($fp, <span class="string">"Connection: close\r\n\r\n"</span>);</span><br><span class="line">	fputs($fp, $data, $content_length);</span><br><span class="line"></span><br><span class="line">	$http_response = stream_get_contents($fp);</span><br><span class="line">	fclose($fp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">list</span>($headers, $body) = explode(<span class="string">"\r\n\r\n"</span>, $http_response, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">return</span> $body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note that the <code>$file</code> parameter would be <code>$_FILES[&#39;your-form-input-name&#39;]</code>, and <code>$file_param_name</code> would be <code>&#39;your-form-input-name&#39;</code>. <code>$data_hash</code>, I assume would be obvious. It’s an associative array with key =&gt; value pairs to send. The upload file would not appear in <code>$data_hash</code>.</p>
</div></div><div class="post-footer"><div class="tags">Tagged in <span><a class="tag-none-link" href="/tags/json/" rel="tag">JSON</a>, <a class="tag-none-link" href="/tags/post/" rel="tag">POST</a>, <a class="tag-none-link" href="/tags/file-upload/" rel="tag">file upload</a>, <a class="tag-none-link" href="/tags/multipart/" rel="tag">multipart</a>, <a class="tag-none-link" href="/tags/multipart-form-data/" rel="tag">multipart/form-data</a>, <a class="tag-none-link" href="/tags/php/" rel="tag">php</a></span></div></div></article><nav class="pages"><a class="page prev" href="/2009/02/19/accessing-aws-simpledb-from-php/" title="Accessing AWS SimpleDB from PHP">Previous</a><a class="page next" href="/2009/01/19/distributed-system-design/" title="Distributed System Design">Next</a></nav></div><footer>Copyright © 2021 Andy VanWagoner. All Rights Reserved.</footer></main><nav><a class="name" href="/about"><img class="avatar" src="/assets/images/andy.jpg"/>Andy VanWagoner</a><ul class="links"><li><a href="/"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M16 9.226l-8-6.21-8 6.21v-2.532l8-6.21 8 6.21zM14 9v6h-4v-4h-4v4h-4v-6l6-4.5z"></path></svg>Home</a></li><li><a href="/faith"><svg class="icon" viewBox="-2 0 16 16" aria-hidden="true"><path d=" M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05 -1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08 -1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L 5.03.3l.02.01z "></path></svg>Faith</a></li><li><a href="/all-categories"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M4 2v14l5-5 5 5v-14zM12 0h-10v14l1-1v-12h9z"></path></svg>Categories</a></li><li><a href="/all-tags"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M15.25 0h-6c-0.412 0-0.989 0.239-1.28 0.53l-7.439 7.439c-0.292 0.292-0.292 0.769 0 1.061l6.439 6.439c0.292 0.292 0.769 0.292 1.061 0l7.439-7.439c 0.292-0.292 0.53-0.868 0.53-1.28v-6c0-0.412-0.338-0.75-0.75-0.75zM11.5 6c -0.828 0-1.5-0.672-1.5-1.5s0.672-1.5 1.5-1.5 1.5 0.672 1.5 1.5-0.672 1.5 -1.5 1.5z "></path></svg>Tags</a></li><li><a href="/archives"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M15.89 10.188l-4-5c-0.095-0.119-0.239-0.188-0.39-0.188h-7c-0.152 0-0.296 0.069-0.39 0.188l-4 5c-0.071 0.089-0.11 0.199-0.11 0.312v4.5c0 0.552 0.448 1 1 1h14c0.552 0 1-0.448 1-1v-4.5c0-0.114-0.039-0.224-0.11-0.312zM15 11h -3.5l-2 2h-3l-2-2h-3.5v-0.325l3.74-4.675h6.519l3.74 4.675v0.325zM11.5 8h-7 c-0.276 0-0.5-0.224-0.5-0.5s0.224-0.5 0.5-0.5h7c0.276 0 0.5 0.224 0.5 0.5s -0.224 0.5-0.5 0.5zM12.5 10h-9c-0.276 0-0.5-0.224-0.5-0.5s0.224-0.5 0.5 -0.5h9c0.276 0 0.5 0.224 0.5 0.5s-0.224 0.5-0.5 0.5z "></path></svg>Archives</a></li></ul><ul class="links"><li><a href="https://github.com/vanwagonet" target="_blank"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M8 0.198c-4.418 0-8 3.582-8 8 0 3.535 2.292 6.533 5.471 7.591 0.4 0.074 0.547-0.174 0.547-0.385 0-0.191-0.008-0.821-0.011-1.489-2.226 0.484-2.695 -0.944-2.695-0.944-0.364-0.925-0.888-1.171-0.888-1.171-0.726-0.497 0.055 -0.486 0.055-0.486 0.803 0.056 1.226 0.824 1.226 0.824 0.714 1.223 1.872 0.869 2.328 0.665 0.072-0.517 0.279-0.87 0.508-1.070-1.777-0.202-3.645 -0.888-3.645-3.954 0-0.873 0.313-1.587 0.824-2.147-0.083-0.202-0.357-1.015 0.077-2.117 0 0 0.672-0.215 2.201 0.82 0.638-0.177 1.322-0.266 2.002-0.269 0.68 0.003 1.365 0.092 2.004 0.269 1.527-1.035 2.198-0.82 2.198-0.82 0.435 1.102 0.162 1.916 0.079 2.117 0.513 0.56 0.823 1.274 0.823 2.147 0 3.073 -1.872 3.749-3.653 3.947 0.287 0.248 0.543 0.735 0.543 1.481 0 1.070-0.009 1.932-0.009 2.195 0 0.213 0.144 0.462 0.55 0.384 3.177-1.059 5.466-4.057 5.466-7.59 0-4.418-3.582-8-8-8z "></path></svg>GitHub</a></li><li><a href="http://stackoverflow.com/users/1701761/andy-vanwagoner" target="_blank"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M16 10v6h-16v-6h2v4h12v-4zM3 11h10v2h-10zM3.237 8.835l0.433-1.953 9.763 2.164-0.433 1.953zM4.37 4.821l0.845-1.813 9.063 4.226-0.845 1.813zM15.496 5.648l-1.218 1.587-7.934-6.088 0.88-1.147h0.91z "></path></svg>Stack Overflow</a></li><li><a href="https://www.linkedin.com/in/andrewvanwagoner" target="_blank"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M6 6h2.767v1.418h0.040c0.385-0.691 1.327-1.418 2.732-1.418 2.921 0 3.461 1.818 3.461 4.183v4.817h-2.885v-4.27c0-1.018-0.021-2.329-1.5-2.329-1.502 0 -1.732 1.109-1.732 2.255v4.344h-2.883v-9zM1 6h3v9h-3v-9zM4 3.5c0 0.828 -0.672 1.5-1.5 1.5s-1.5-0.672-1.5-1.5c0-0.828 0.672-1.5 1.5-1.5s1.5 0.672 1.5 1.5z "></path></svg>LinkedIn</a></li></ul><ul class="links"><li><a href="/atom.xml"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M2.13 11.733c-1.175 0-2.13 0.958-2.13 2.126 0 1.174 0.955 2.122 2.13 2.122 1.179 0 2.133-0.948 2.133-2.122-0-1.168-0.954-2.126-2.133-2.126zM0.002 5.436v3.067c1.997 0 3.874 0.781 5.288 2.196 1.412 1.411 2.192 3.297 2.192 5.302h3.080c-0-5.825-4.739-10.564-10.56-10.564zM0.006 0v3.068c7.122 0 12.918 5.802 12.918 12.932h3.076c0-8.82-7.176-16-15.994-16z "></path></svg>Feed</a></li></ul></nav></html>