<!doctype html>
<html><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Greater than the sum of its components - Andy’s Scribbles</title><meta name="author" content="Andy VanWagoner"/><meta name="description" content="Andy’s Scribbles"/><link rel="icon" href="/assets/images/favicon.ico"/><link rel="alternative" type="application/atom+xml" title="RSS" href="atom.xml"/><link rel="stylesheet" href="/assets/css/style.css"/><header><h1><a href="https://andy.vanwago.net">Andy’s Scribbles <img class="logo" alt="Inkwell with angle brackets" src="/assets/images/favicon.svg"/></a></h1></header><main><div><article class="post" itemscope="" itemType="http://schema.org/BlogPosting"><h2 itemProp="headline"><a href="https://andy.vanwago.net/2013/02/19/greater-than-the-sum-of-its-components/" itemProp="url">Greater than the sum of its components</a></h2><div class="meta"><time itemProp="datePublished" dateTime="2013-02-20T00:36:43.000Z">Feb 19, 2013</time> in <span><a class="category-link" href="/categories/javascript/">JavaScript</a></span></div><div itemProp="articleBody"><div><p>Lately I’ve been working on a cool project written exclusively in JavaScript, with a <a href="http://nodejs.org/" target="_blank" rel="noopener">Node.js</a> &amp; <a href="http://www.mongodb.org/" target="_blank" rel="noopener">MongoDB</a> back end, and a <a href="http://thetalecrafter.github.com/modules/" target="_blank" rel="noopener">CommonJS</a> <a href="http://backbonejs.org/" target="_blank" rel="noopener">Backbone</a> front end. What I have found most fun so far is the synergy I get between certain components.</p>
<p><strong>Templates</strong></p>
<p>First off, I admit I’m a reinvent-the-wheel kind of engineer. I readily find some minor fault in existing solutions and decide I have to write my own. <a href="https://github.com/visionmedia/ejs" target="_blank" rel="noopener">EJS</a> is really great, especially for someone coming from a PHP background, who doesn’t think logic-less templates are better than sliced bread. However, I really needed templates that can run asynchronously, doing file or network io for includes and other such magic.</p>
<p>So, I made <a href="http://thetalecrafter.github.com/stencil/" target="_blank" rel="noopener">Stencil</a>. I was able to make templates that compile without mucking up the line numbers, so debugging is very straight-forward. No exception rethrowing necessary. The very-important async use case was satisfied without making all templates forced to use the async pattern.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sync_result = sync_tpl(data); <span class="comment">// works if no async code in template</span></span><br><span class="line">async_tpl(data, <span class="function"><span class="keyword">function</span>(<span class="params">err, async_result</span>) </span>&#123; &#125;); <span class="comment">// always works</span></span><br></pre></td></tr></table></figure>
<p>Where the whole becomes more than the sum of parts: A small snippet makes it so I can directly <code>require</code> my templates, and get back the function instead of the string:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>.extensions[<span class="string">'.html'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>), stencil = <span class="built_in">require</span>(<span class="string">'stencil-js'</span>),</span><br><span class="line">		opts = &#123; <span class="attr">id</span>:filename, <span class="attr">src</span>:fs.readFileSync(filename, <span class="string">'utf8'</span>) &#125;;</span><br><span class="line">	<span class="built_in">module</span>._compile(</span><br><span class="line">		<span class="string">'module.exports='</span> + stencil.compile(opts, <span class="literal">true</span>) + <span class="string">';'</span>,</span><br><span class="line">		filename</span><br><span class="line">	);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Now the rest of my code that uses templates doesn’t have to care that I use Stencil. You just <code>tpl = require(&#39;path/to/template.html&#39;)</code>. This is possible because Node.js has an extensible require, and Stencil allows you to compile to a JavaScript string instead of just to a function. If I were to go back and change the templating system to EJS, Jade, or Mustache, I would only need to update this one little snippet.</p>
<p><strong>Client CommonJS</strong></p>
<p>I liked Node.js’s module system, and I didn’t want to have to <a href="http://requirejs.org/docs/node.html" target="_blank" rel="noopener">replace it</a> or use a separate system on the front end. Don’t get me started on mess of <a href="https://github.com/umdjs/umd" target="_blank" rel="noopener">UMD</a>. So, I created my own <a href="http://thetalecrafter.github.com/modules/" target="_blank" rel="noopener">Modules library</a>. You’ve <a href="http://thetalecrafter.com/2010/01/30/javascript-require-in-100-lines-of-code/" title="JavaScript require in 100 lines of code" target="_blank" rel="noopener">heard</a> <a href="http://thetalecrafter.com/2011/04/13/load-only-when-needed-or-preload-everything/" title="Load only when needed, or Preload everything?" target="_blank" rel="noopener">about</a> this <a href="http://thetalecrafter.com/2011/09/22/commonjs-in-the-browser/" title="CommonJS in the Browser" target="_blank" rel="noopener">before</a>.</p>
<p>I got CommonJS modules to load (asynchronously) and run in the browser, so it was trivial to share code used on both ends. Again, line numbers weren’t munged in the server-side translation, so debugging works just like you always expect it to.</p>
<p>The library runs as a middleware for <a href="http://expressjs.com/" target="_blank" rel="noopener">Express</a>, enabling the reload functionality <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank" rel="noopener">AMD</a> lovers rave about, as well as standalone for concatenating and minifying bundles in the production build process. All with a client-side weight one-third that of <a href="https://github.com/jrburke/almond" target="_blank" rel="noopener">AlmondJS</a>, although that or <a href="http://requirejs.org/" target="_blank" rel="noopener">RequireJS</a> would also work on the front-end, since Modules still uses AMD as its transport format.</p>
<p>The real magic though, is that the Modules library has an option for translating certain types of files, giving us the same <code>require</code> functionality for our templates that we had on the server, and because the translation happens server side (or at build time), the client code can keep a <a href="http://www.html5rocks.com/en/tutorials/security/content-security-policy/" target="_blank" rel="noopener">Content Security Policy</a> that disallows eval and unsafe inline code, as Stencil never has to be loaded in client code. (Lighter &amp; more secure. Woohoo!)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'modules'</span>).middleware(&#123;</span><br><span class="line">	translate:&#123;</span><br><span class="line">		html:<span class="function"><span class="keyword">function</span> <span class="title">tpl</span>(<span class="params">name, file, src</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> opts = &#123; <span class="attr">id</span>:name, <span class="attr">src</span>:src &#125;;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">'module.exports='</span> + stencil.compile(opts, <span class="literal">true</span>) + <span class="string">';'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	root: <span class="string">'./components/'</span>, <span class="comment">// file root path</span></span><br><span class="line">	path: <span class="string">'/module/'</span>, <span class="comment">// url root path</span></span><br><span class="line">	<span class="comment">// ... other options</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p><strong>Backbone</strong></p>
<p>One magic thing that I got for free, is that Backbone and Underscore are already CommonJS compatible, so passing them through the same middleware just worked. <a href="https://github.com/caolan/async" target="_blank" rel="noopener">Async</a>, and countless other Node.js modules also just work.</p>
<p><strong>Adding it all together</strong></p>
<p>While I chose to write my own templating and module components, many other libraries include the little hooks that make these synergies possible. Each component individually is really nothing spectacular, but when you put them all together you get a product that is cohesive from front to back, and really fun to work on.</p>
</div></div><div class="post-footer"><div class="tags">Tagged in <span><a class="tag-none-link" href="/tags/amd/" rel="tag">AMD</a>, <a class="tag-none-link" href="/tags/commonjs/" rel="tag">CommonJS</a>, <a class="tag-none-link" href="/tags/javascript/" rel="tag">JavaScript</a>, <a class="tag-none-link" href="/tags/node-js/" rel="tag">Node.js</a>, <a class="tag-none-link" href="/tags/require/" rel="tag">require</a></span></div></div></article><nav class="pages"><a class="page prev" href="/2015/05/11/async-functions-delivering-on-promises/" title="Async Functions: Delivering on Promises">Previous</a><a class="page next" href="/2012/02/14/a-case-against-vendor-prefixes-in-css/" title="A Case Against Vendor Prefixes In CSS">Next</a></nav></div><footer>Copyright © 2021 Andy VanWagoner. All Rights Reserved.</footer></main><nav><a class="name" href="/about"><img class="avatar" src="/assets/images/andy.jpg"/>Andy VanWagoner</a><ul class="links"><li><a href="/"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M16 9.226l-8-6.21-8 6.21v-2.532l8-6.21 8 6.21zM14 9v6h-4v-4h-4v4h-4v-6l6-4.5z"></path></svg>Home</a></li><li><a href="/faith"><svg class="icon" viewBox="-2 0 16 16" aria-hidden="true"><path d=" M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05 -1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08 -1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L 5.03.3l.02.01z "></path></svg>Faith</a></li><li><a href="/all-categories"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d="M4 2v14l5-5 5 5v-14zM12 0h-10v14l1-1v-12h9z"></path></svg>Categories</a></li><li><a href="/all-tags"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M15.25 0h-6c-0.412 0-0.989 0.239-1.28 0.53l-7.439 7.439c-0.292 0.292-0.292 0.769 0 1.061l6.439 6.439c0.292 0.292 0.769 0.292 1.061 0l7.439-7.439c 0.292-0.292 0.53-0.868 0.53-1.28v-6c0-0.412-0.338-0.75-0.75-0.75zM11.5 6c -0.828 0-1.5-0.672-1.5-1.5s0.672-1.5 1.5-1.5 1.5 0.672 1.5 1.5-0.672 1.5 -1.5 1.5z "></path></svg>Tags</a></li><li><a href="/archives"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M15.89 10.188l-4-5c-0.095-0.119-0.239-0.188-0.39-0.188h-7c-0.152 0-0.296 0.069-0.39 0.188l-4 5c-0.071 0.089-0.11 0.199-0.11 0.312v4.5c0 0.552 0.448 1 1 1h14c0.552 0 1-0.448 1-1v-4.5c0-0.114-0.039-0.224-0.11-0.312zM15 11h -3.5l-2 2h-3l-2-2h-3.5v-0.325l3.74-4.675h6.519l3.74 4.675v0.325zM11.5 8h-7 c-0.276 0-0.5-0.224-0.5-0.5s0.224-0.5 0.5-0.5h7c0.276 0 0.5 0.224 0.5 0.5s -0.224 0.5-0.5 0.5zM12.5 10h-9c-0.276 0-0.5-0.224-0.5-0.5s0.224-0.5 0.5 -0.5h9c0.276 0 0.5 0.224 0.5 0.5s-0.224 0.5-0.5 0.5z "></path></svg>Archives</a></li></ul><ul class="links"><li><a href="https://github.com/vanwagonet" target="_blank"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M8 0.198c-4.418 0-8 3.582-8 8 0 3.535 2.292 6.533 5.471 7.591 0.4 0.074 0.547-0.174 0.547-0.385 0-0.191-0.008-0.821-0.011-1.489-2.226 0.484-2.695 -0.944-2.695-0.944-0.364-0.925-0.888-1.171-0.888-1.171-0.726-0.497 0.055 -0.486 0.055-0.486 0.803 0.056 1.226 0.824 1.226 0.824 0.714 1.223 1.872 0.869 2.328 0.665 0.072-0.517 0.279-0.87 0.508-1.070-1.777-0.202-3.645 -0.888-3.645-3.954 0-0.873 0.313-1.587 0.824-2.147-0.083-0.202-0.357-1.015 0.077-2.117 0 0 0.672-0.215 2.201 0.82 0.638-0.177 1.322-0.266 2.002-0.269 0.68 0.003 1.365 0.092 2.004 0.269 1.527-1.035 2.198-0.82 2.198-0.82 0.435 1.102 0.162 1.916 0.079 2.117 0.513 0.56 0.823 1.274 0.823 2.147 0 3.073 -1.872 3.749-3.653 3.947 0.287 0.248 0.543 0.735 0.543 1.481 0 1.070-0.009 1.932-0.009 2.195 0 0.213 0.144 0.462 0.55 0.384 3.177-1.059 5.466-4.057 5.466-7.59 0-4.418-3.582-8-8-8z "></path></svg>GitHub</a></li><li><a href="http://stackoverflow.com/users/1701761/andy-vanwagoner" target="_blank"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M16 10v6h-16v-6h2v4h12v-4zM3 11h10v2h-10zM3.237 8.835l0.433-1.953 9.763 2.164-0.433 1.953zM4.37 4.821l0.845-1.813 9.063 4.226-0.845 1.813zM15.496 5.648l-1.218 1.587-7.934-6.088 0.88-1.147h0.91z "></path></svg>Stack Overflow</a></li><li><a href="https://www.linkedin.com/in/andrewvanwagoner" target="_blank"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M6 6h2.767v1.418h0.040c0.385-0.691 1.327-1.418 2.732-1.418 2.921 0 3.461 1.818 3.461 4.183v4.817h-2.885v-4.27c0-1.018-0.021-2.329-1.5-2.329-1.502 0 -1.732 1.109-1.732 2.255v4.344h-2.883v-9zM1 6h3v9h-3v-9zM4 3.5c0 0.828 -0.672 1.5-1.5 1.5s-1.5-0.672-1.5-1.5c0-0.828 0.672-1.5 1.5-1.5s1.5 0.672 1.5 1.5z "></path></svg>LinkedIn</a></li></ul><ul class="links"><li><a href="/atom.xml"><svg class="icon" viewBox="0 0 16 16" aria-hidden="true"><path d=" M2.13 11.733c-1.175 0-2.13 0.958-2.13 2.126 0 1.174 0.955 2.122 2.13 2.122 1.179 0 2.133-0.948 2.133-2.122-0-1.168-0.954-2.126-2.133-2.126zM0.002 5.436v3.067c1.997 0 3.874 0.781 5.288 2.196 1.412 1.411 2.192 3.297 2.192 5.302h3.080c-0-5.825-4.739-10.564-10.56-10.564zM0.006 0v3.068c7.122 0 12.918 5.802 12.918 12.932h3.076c0-8.82-7.176-16-15.994-16z "></path></svg>Feed</a></li></ul></nav></html>